<template>
  <div class="container">
    <h2>{{ $t('Cafes.ourCafesTitle') }}</h2>
    <div class="row">
      <div
        v-for="(ourCafe, index) in ourCafesData"
        class="col-md-6"
        :key="index"
      >
        <div
          class="cafe-image-tile js-scroll-to-map"
          :data-address="ourCafe.dataAddress"
        >
          <div
            class="cafe-image-tile-image-wrapper"
            :style="{
              backgroundImage: ourCafe.imageLink,
              backgroundSize: 'cover',
              backgroundPosition: 'right',
            }"
          ></div>
          <div class="cafe-image-tile-content">
            <h3 class="cafe-image-tile-name">{{ ourCafe.name }}</h3>
            <address class="cafe-tile-address">
              <span :name="ourCafe.name" class="cafe-tile-address-anchor">
                {{ ourCafe.street }}, {{ ourCafe.city }}<br />{{
                  ourCafe.zipCode
                }}, {{ ourCafe.countryWithState }}
              </span>
            </address>
            <p>{{ ourCafe.phone }}</p>
          </div>
        </div>
      </div>
    </div>
    <h2>{{ $t('Cafes.partnerCafesTitle') }}</h2>
    <div class="row">
      <div v-for="(location, index) in locations" :key="index">
        <h3>{{ location }}</h3>
        <template v-for="(partnerCafeModel, index) in partnerCafesData">
          <p :key="index" v-if="partnerCafeModel.location === location">
            {{ partnerCafeModel.name }}, {{ partnerCafeModel.street }},
            {{ partnerCafeModel.phone }}
          </p>
        </template>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { onMounted, ref, watch } from 'vue';
import { useI18n } from 'vue-i18n';
import { Client } from '../Client.js';
import { computed } from '@vue/reactivity';
import {
  initLanguageCodeObject,
  defaultLanguage,
  initLanguageCodeObjectWithArray,
} from '../Utilities/LanguageCodes';
import type { Cafe } from '@/models';

interface CafeModel {
  name: string;
  email: string;
  imageLink: string;
  street: string;
  city: string;
  zipCode: string;
  country: string;
  state: string;
  phone: string;
  dataAddress: string;
  countryWithState: string;
  location: string;
}

const { locale } = useI18n();
const ourCafes = ref<Array<Cafe>>([]);
const partnerCafes = ref<Array<Cafe>>([]);

const locations = computed<Array<string>>(() =>
  partnerCafesData.value
    .map((model) => model.location)
    .reduce<Array<string>>((result, location) => {
      if (result.indexOf(location) < 0) {
        result.push(location);
      }
      return result;
    }, [])
    .sort()
);

const partnerCafesData = computed<Array<CafeModel>>(() =>
  partnerCafes.value.map((cafe) => getModel(cafe))
);

const ourCafesData = computed<Array<CafeModel>>(() =>
  ourCafes.value.map((cafe) => getModel(cafe))
);

const getModel = (cafe: Cafe): CafeModel => {
  const model = {
    name: cafe.system.name,
    email: cafe.elements.email.value,
    imageLink: 'url(' + cafe.elements.photo.value[0].url + ')',
    street: cafe.elements.street.value,
    city: cafe.elements.city.value,
    zipCode: cafe.elements.zipCode.value,
    country: cafe.elements.country.value,
    state: cafe.elements.state.value,
    phone: cafe.elements.phone.value,
  };

  const addressModel = {
    dataAddress: model.city + ', ' + model.street,
    countryWithState: model.country + (model.state ? ', ' + model.state : ''),
  };

  const locationModel = {
    location: model.city + ', ' + addressModel.countryWithState,
  };

  return { ...model, ...addressModel, ...locationModel };
};

const fetchCafes = (): void => {
  const cafesList = initLanguageCodeObjectWithArray<Cafe>();

  let query = Client.items<Cafe>()
    .type('cafe')
    .orderParameter('elements.name', 'desc');

  if (locale.value) {
    query.languageParameter(locale.value);
  }

  query.toPromise().then((response) => {
    if (locale.value) {
      cafesList[locale.value] = response.data.items;
    } else {
      cafesList[defaultLanguage] = response.data.items;
    }

    ourCafes.value = locale.value
      ? cafesList[locale.value].filter(
          (cafe) => cafe.elements.country.value === 'USA'
        )
      : cafesList[defaultLanguage].filter(
          (cafe) => cafe.elements.country.value === 'USA'
        );

    partnerCafes.value = locale.value
      ? cafesList[locale.value].filter(
          (cafe) => cafe.elements.country.value !== 'USA'
        )
      : cafesList[defaultLanguage].filter(
          (cafe) => cafe.elements.country.value !== 'USA'
        );
  });
};

onMounted(() => fetchCafes());

watch(locale, () => {
  fetchCafes();
});
</script>
